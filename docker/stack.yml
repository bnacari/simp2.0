# ============================================
# SIMP 2.0 - Stack de Produção
# ============================================
# Deploy: docker stack deploy -c stack.yml simp20-php
# ============================================

services:
  simp20-php:
    image: "${DOCKER_IMAGE_TAG}"
    labels:
      - "br.com.cesan.app=${CI_PROJECT_NAME}"
      - "io.portainer.accesscontrol.teams=adm"
    environment:
      - DB_HOST=${DB_HOST}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - TENSORFLOW_URL=http://simp20-tensorflow:5000
      - http_proxy=http://cntlm:3128/
      - https_proxy=http://cntlm:3128/
      - HTTP_PROXY=http://cntlm:3128/
      - HTTPS_PROXY=http://cntlm:3128/
      - no_proxy=localhost,127.0.0.1,simp20-tensorflow,simp20-php
      - NO_PROXY=localhost,127.0.0.1,simp20-tensorflow,simp20-php
    networks:
      - frontend
      - cntlm
    ports:
      - 9461:80
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /nfs/swarm/simp20-php/modelos_treinados:/var/www/html/modelos_treinados
    deploy:
      mode: replicated
      resources:
        limits:
          cpus: '2'
          memory: 4192M

  simp20-tensorflow:
    image: "registry.cesan.com.br/cesan/simp20-tensorflow:latest"
    labels:
      - "br.com.cesan.app=${CI_PROJECT_NAME}"
      - "io.portainer.accesscontrol.teams=adm"
    environment:
      - DB_HOST=${DB_HOST}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - PORT=5000
      - FLASK_ENV=production
      - MODELS_DIR=/app/models
      - http_proxy=http://cntlm:3128/
      - https_proxy=http://cntlm:3128/
      - HTTP_PROXY=http://cntlm:3128/
      - HTTPS_PROXY=http://cntlm:3128/
      - no_proxy=localhost,127.0.0.1,simp20-php
      - NO_PROXY=localhost,127.0.0.1,simp20-php
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /nfs/swarm/simp20-php/modelos_treinados:/app/models
    networks:
      - cntlm
    deploy:
      mode: replicated
      resources:
        limits:
          cpus: '2'
          memory: 4096M

  simp20-cronjob:
    image: registry.cesan.com.br/library/curlimages/curl:8.8.0
    labels:
      - "br.com.cesan.app=${CI_PROJECT_NAME}"
      - "io.portainer.accesscontrol.teams=adm"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - frontend
    command: "-m 3600 --noproxy '*' http://simp20-php/bd/operacoes/motorBatchTratamento.php?acao=executar_batch"
    deploy:
      mode: replicated
      replicas: 0
      restart_policy:
        condition: none
      labels:
        - "swarm.cronjob.enable=true"
        - "swarm.cronjob.schedule=30 4 * * *"
        - "swarm.cronjob.skip-running=false"
      resources:
        limits:
          cpus: '2'
          memory: 1024M

# ============================================
# Networks
# ============================================
networks:
  cntlm:
    name: backing-services_cntlm
    external: true
  frontend:
